name: AWS Continuous Deployment Pipeline

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  ECR_REPO: 210291640622.dkr.ecr.us-east-1.amazonaws.com/mira-api
  LAMBDA_IMAGE_URI: 210291640622.dkr.ecr.us-east-1.amazonaws.com/mira-api:lambda-${{ github.sha }}
  EC2_IMAGE_URI: 210291640622.dkr.ecr.us-east-1.amazonaws.com/mira-api:prod-${{ github.sha }}

jobs:
  build_and_push:
    name: Build and Push Docker Images to ECR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Lambda image
        run: |
          docker build -t mira-api:lambda -f docker/Dockerfile.lambda .
          docker tag mira-api:lambda ${{ env.LAMBDA_IMAGE_URI }}
          docker push ${{ env.LAMBDA_IMAGE_URI }}

      - name: Build, tag, and push EC2 image
        run: |
          docker build -t mira-api:prod -f docker/Dockerfile.prod .
          docker tag mira-api:prod ${{ env.EC2_IMAGE_URI }}
          docker push ${{ env.EC2_IMAGE_URI }}

  update_lambda:
    name: Update Lambda Function
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name mira-api \
            --image-uri ${{ env.LAMBDA_IMAGE_URI }}

      - name: Wait for Lambda to update
        run: aws lambda wait function-updated --function-name mira-api

      - name: Run Alembic migrations via Lambda
        run: |
          aws lambda invoke \
            --function-name mira-api \
            --payload '{"action":"run_migrations"}' \
            --cli-binary-format raw-in-base64-out \
            --log-type Tail \
            out.json
          cat out.json

  update_ec2:
    name: Update EC2 Instance
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: SSH into EC2 and update container
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            aws ecr get-login-password --region us-east-1 | docker login \
              --username AWS \
              --password-stdin 210291640622.dkr.ecr.us-east-1.amazonaws.com

            docker pull ${{ env.EC2_IMAGE_URI }}
            docker stop mira-api || true
            docker rm mira-api || true
            docker run -d --name mira-api -p 80:80 ${{ env.EC2_IMAGE_URI }}
